<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" contents="{{description}}">
    <link rel="manifest" href="/manifest.json">
    <title>Gallery (v1.1-lazy)</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/anywhere3d.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.js"></script>
    <script src="/js/jquery.lazy.js"></script>
    <script src="/js/jquery.lazy.plugins.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootbox.min.js"></script>
    <script src="/js/DeviceDetector.js"></script>
    <script src="/js/alerts.js"></script>
    <script src="/js/w3.js"></script>
    <script>
    
        debugMode = true;
        var jsFolder = "/js/";
        var navbarFolder = "/navbar/";
        var scriptsFolder = "/scripts/";
        var componentsFolder = "/components/";
        var animationsFolder = "/animations/";
        $.ajaxSetup({ cache: true });

    </script>

    <style>
        section.mbr-section.mbr-after-navbar { padding-top:100px; padding-bottom:20px; }
        #msg-box1-z { margin-bottom: 0px; }
        #render-container { overflow:hidden; opacity:1; background-color:rgba(0,0,0,0); }
        #render-container > canvas { position:absolute; top:0px; left:0px; z-index:1; }
        #msg-box1-z > div.nav {background-color:black; width:100%;}
        #msg-box1-z > div.nav > div.navbar-right { margin-right:0px; padding-right:10px; }
    </style>

    <style>
        .gallery-card { width:22.8rem; display:inline-block; }
        #snapshot-img { width:100%; height:auto; }
        #get-more-snapshots { display:block; width:20%; margin:auto; margin-bottom:50px; }
        #get-more-snapshots > a { text-decoration:none; font-weight:bold; }
    </style>

</head>

<body>

<nav class="navbar navbar-default navbar-fixed-top">

    <div id="navbar-holder" class="container">
        <!-- navbar load script -->
        <style>
            .navbar-nav > li > a.menu-item,
            .navbar-nav > li > div > a.menu-item {font-weight:normal;}
            .navbar-nav > li > a.menu-item:hover,
            .navbar-nav > li > div > a.menu-item:hover {color:aquamarine;}
            .navbar-nav > li > div > a.menu-item { text-decoration:none }
            #nav-btn-login { margin-left:10px; }
            #nav-btn-login > a { color:#fff; font-weight:bold; font-size:14px; text-decoration:none; }
            #nav-btn-snapshot > a { color:#38c0ee; }
        </style>

        <div class="navbar-brand">
            <a href="https://anywhere3d.org" class="navbar-caption" title="anywhere3d.org">anywhere3d</a>
        </div>
        <a class="navbar-logo pull-left"><img src="https://i.imgur.com/09bC4Q0.png" alt="anywhere3d logo"></a>

        <div class="navbar-header">
          <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <div class="navbar-collapse collapse" id="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <ul class="nav navbar-nav navbar-right pull-left">
                
                <li class="first menu-item"></li>

                <li id="nav-item-index"><a href="/" class="menu-item"><div>Home</div></a></li>
                <li id="nav-item-gallery" class="gallery-data"><a class="menu-item"><div>Gallery</div></a></li>
                <li id="nav-item-snapshots" class="gallery-data"><a class="menu-item"><div>Snapshots</div></a></li>
                <li id="nav-item-textures" class="gallery-data"><a class="menu-item"><div>Textures</div></a></li>
                <li id="nav-item-forum"><a href="http://anywhere3d.freeforums.net" target="_blank" class="menu-item"><div>Forum</div></a></li>
                <li id="nav-item-help"><a href="/help" target="_blank" class="menu-item"><div>Help</div></a></li>
            </ul>
        </div>

    </div>

</nav>

<section class="mbr-section mbr-after-navbar" id="pager-box-top">

    <div class="container">

        <h1><b>Gallery:</b></h1>
        <a class="btn btn-primary get-prev-btn">Prev page</a>
        <div class="pgr-buttons-holder" style="display:inline;">
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
            <a class="btn btn-default page-btn"></a>
        </div>
        <a class="btn btn-primary get-next-btn">Next page</a>

        <div class="pull-right small" style="text-align:right;">
            page:<span id="page"></span>, displaying <span id="length"></span> items,<br>(from <span id="from"></span> to <span id="to"></span>) of total <span id="count"></span>
        </div>

    </div>

</section>

<section class="mbr-section" id="body-section">
    <div id="snapshots-cards" class="container">
        <div class="card thumbnail gallery-card" w3-repeat="snapshots">
            <img class="card-img-top lazy" data-src="https://i.imgur.com/{{id}}m.jpg" alt="{{title}}">
            <div class="card-body">
                <h4 class="card-title">{{title}}</h4>
            </div>
        </div>
    </div>
</section>

<section class="mbr-section" id="pager-box-bottom">
    <div class="btn btn-default load-more-btn" id="get-more-snapshots">
        <a>Load more...</a>
    </div>
</section>

<script>

    var bodySectionSelector = "#body-section";
    $(bodySectionSelector).data("collection", "gallery");
    var galleryCardsComponent = componentsFolder + "gallery-cards.html";

    var snapshots = [];

    var selectors = {};

    var options = {
        skip: 0,
        limit: 20,
        sort: {_id: -1 },
    };

    $(function(){

        var data = {
            options:   JSON.stringify( options ),
            selectors: JSON.stringify( selectors ),
        };
        
        var endpoint = "/" + $(bodySectionSelector).data("collection") + "/find/selectors/options";
    
        var jqxhr = $.post( endpoint, data, function(data, status, xhr){
            debugMode && console.log("post %s: %s", endpoint, status);
        }).then( function( data ){
            debugMode && console.log("data:", data);
            var object = {snapshots: snapshots.concat(data.success)};
            w3.displayObject("snapshots-cards", object);
            $("img.lazy").Lazy({
                chainable: false,
                effect:"fadeIn",
                effectTime:250,
            });
            return data.success;
        });
        
        jqxhr.done( function( results ){
            debugMode && console.log("results:", results);
            $("span#length").text(results.length);
            $("span#page").text(page_index + 1);
            $("span#from").text(skip + 1);
            $("span#to").text(skip + results.length);
        //  $("span#count").text(count);
            snapshots = snapshots.concat(results);
        });
    
        jqxhr.fail( function( err ){
            console.error( err );
        });

    });

</script>


<script>

    var count;
    var clickTimeout;
    var skip  = options.skip;
    var limit = options.limit;
    var page_index = parseInt( skip / limit );

    var log = "page_index: %i, skip: %i/%i, limit: %i/%i, count:%i.";
    debugMode && console.log( log, page_index, skip, options.skip, limit, options.limit, count );

    var getNextBtnSelector = ".get-next-btn";
    var getPrevBtnSelector = ".get-prev-btn";
    var loadMoreBtnSelector = ".load-more-btn";

    $(getNextBtnSelector).on("click", getNextPageClickHandler);
    $(getPrevBtnSelector).on("click", getPrevPageClickHandler);
    $(loadMoreBtnSelector).on("click", loadMoreItemsClickHandler);    

    countCatalogItems();

    function getNextPageClickHandler(){
        debugMode && console.log("snapshots:", snapshots);

        if ( !count || skip + options.limit >= count ) return false;
        clearTimeout(clickTimeout);

        snapshots.length = 0;

        page_index++; 
        skip = page_index * limit;
        $("span#page").text(page_index + 1);

        options.skip = skip; 
        options.limit = limit;

        debugMode && console.log( log, page_index, skip, options.skip, limit, options.limit, count );
        clickTimeout = setTimeout(fetchGalleryItems, 500, selectors, options);

    }

    function getPrevPageClickHandler(){
        debugMode && console.log("snapshots:", snapshots);

        if ( page_index - 1 < 0 ) return false;
        clearTimeout(clickTimeout);

        snapshots.length = 0;

    //  $("span#page").text(page_index);
        page_index--; 
        skip = page_index * limit;
        $("span#page").text(page_index + 1);

        options.skip = skip; 
        options.limit = limit;

        debugMode && console.log( log, page_index, skip, options.skip, limit, options.limit, count );
        clickTimeout = setTimeout(fetchGalleryItems, 500, selectors, options);

    }

    function loadMoreItemsClickHandler(){
        debugMode && console.log("snapshots:", snapshots);

        if ( !count || skip + options.limit >= count ) return false;
        clearTimeout(clickTimeout);

        page_index++; 
        skip = page_index * limit;
        $("span#page").text(page_index + 1);

        options.skip = skip; 
        options.limit = limit; //  options.limit = options.limit + limit;

        debugMode && console.log( log, page_index, skip, options.skip, limit, options.limit, count );
        clickTimeout = setTimeout(fetchGalleryItems, 500, selectors, options);
    }

    function fetchGalleryItems( selectors, options, callback ){

        var data = {
            options:   JSON.stringify( options ),
            selectors: JSON.stringify( selectors ),
        };

        var endpoint = "/" + $(bodySectionSelector).data("collection") + "/find/selectors/options";

        var jqxhr = $.post( endpoint, data, function(data, status, xhr){
            debugMode && console.log("post %s: %s", endpoint, status);
        }).then( function( data ){
            debugMode && console.log("data:", data);
            var object = {snapshots: snapshots.concat(data.success)};
            w3.displayObject("snapshots-cards", object);
            $("img.lazy").Lazy({
                chainable: false,
                effect:"fadeIn",
                effectTime:250,
            });
            return data.success;
        });

        jqxhr.done( function(results){
            $("span#page").text(page_index + 1);
            $("span#from").text(skip - snapshots.length + 1);
            $("span#to").text(skip + results.length);
            snapshots = snapshots.concat(results);
            $("span#length").text(snapshots.length);
        });

        jqxhr.fail( function( err ){
            console.error(err);
        });

        jqxhr.always( function(){
            countCatalogItems();
            if (!!callback) callback();
        });

    }

    function countCatalogItems(){

        var options = {};
        debugMode && console.log( "selectors:", selectors );

        var data = {
            options:   JSON.stringify( options ),
            selectors: JSON.stringify( selectors ),
        };

        var endpoint = "/" + $(bodySectionSelector).data("collection") + "/count/selectors/options";

        var jqxhr = $.post( endpoint, data, function(data, status, xhr){
        //  debugMode && console.log("data:", data);
        }).then( function( data ){
            return data.count;
        });

        jqxhr.done( function( count ){
            debugMode && console.log( "count:", count );
            $("span#count").text(count);
        });

        jqxhr.fail( function( err ){
            console.error(err);
        });
    }

</script>

<script>

    var btn_index;
    var primaryClass = "btn-primary";
    var pageBtnSelector = ".page-btn";

    $( pageBtnSelector ).toArray()
    .forEach( function( button, i ){
        $(button).data("index", i);
        $(button).text( i + 1 );
        if ( i == 0 ) $(button).addClass( primaryClass );
    });

    $( pageBtnSelector ).on("click", function(){
        clearTimeout(clickTimeout);
        snapshots.length = 0;
        $( pageBtnSelector ).removeClass( primaryClass );
    });

    $( pageBtnSelector ).on("click", function(){
        clearTimeout(clickTimeout);
        $( this ).addClass( primaryClass );
        page_index = $(this).data("index");
        btn_index = $( pageBtnSelector ).index( this ); // how to find btn index example //
        debugMode && console.log("page_index: %i, btn_index: %i", page_index, btn_index);
    });

    $( pageBtnSelector ).on("click", function(){
        clearTimeout(clickTimeout);
        skip = page_index * limit;
        options.skip = skip; 
        options.limit = limit;
        $("span#page").text(page_index + 1);
        debugMode && console.log( log, page_index, skip, options.skip, limit, options.limit, count );
    });

    $( pageBtnSelector ).on("click", function(){
        clearTimeout(clickTimeout);
        clickTimeout = setTimeout(fetchGalleryItems, 1000, selectors, options);
    });

    $(getNextBtnSelector).on("click", pagenation);
    $(getPrevBtnSelector).on("click", pagenation);
    $(loadMoreBtnSelector).on("click", pagenation);

    function pagenation(){
        $(pageBtnSelector).removeClass( primaryClass );

        var l = $( pageBtnSelector ).length;
        var d = parseInt( page_index / l );
        var m = page_index % l;

        var n = l * d;
        $( pageBtnSelector ).toArray()
        .forEach( function( button, i ){
            var index = n + i;
            $(button).data("index", index);
            $(button).text( index + 1 );
        });
        
        var currentPageBtn = $(pageBtnSelector)[m];
        $(currentPageBtn).addClass( primaryClass );

    }

</script>

<script>

    var galleryDataSelector = ".gallery-data";
    var navGallerySelector = "#nav-item-gallery";
    var navTexturesSelector = "#nav-item-textures";
    var navSnapshotsSelector = "#nav-item-snapshots";

    $(navGallerySelector).on("click", function(){
        snapshots.length = 0;
        $(bodySectionSelector).data("collection", "gallery");
    });

    $(navTexturesSelector).on("click", function(){
        snapshots.length = 0;
        $(bodySectionSelector).data("collection", "textures");
    });

    $(navSnapshotsSelector).on("click", function(){
        snapshots.length = 0;
        $(bodySectionSelector).data("collection", "snapshots");
    });

    $(galleryDataSelector).on("click", function(){
        $( pageBtnSelector ).removeClass( primaryClass );
        $( pageBtnSelector ).toArray()
        .forEach( function( button, i ){
            $(button).data("index", i);
            $(button).text( i + 1 );
            if ( i == 0 ) $(button).addClass( primaryClass );
        });
    });

    $(galleryDataSelector).on("click", function(){
        selectors = {};
        options.skip = 0;
        options.limit = 20;
        options.sort = {_id: -1 };
        skip  = options.skip;
        limit = options.limit;
        page_index = parseInt( skip / limit );
    });

    $(galleryDataSelector).on("click", function(){
        clearTimeout(clickTimeout);
        clickTimeout = setTimeout(function(selectors, options){
        
            var data = {
                options:   JSON.stringify( options ),
                selectors: JSON.stringify( selectors ),
            };

            var endpoint = "/" + $(bodySectionSelector).data("collection") + "/find/selectors/options";

            var jqxhr = $.post( endpoint, data, function(data, status, xhr){
                debugMode && console.log("post %s: %s", endpoint, status);
            }).then( function( data ){
                debugMode && console.log("data:", data);
                var object = {snapshots: data.success};
                w3.displayObject("snapshots-cards", object);
                $("img.lazy").Lazy({
                    chainable: false,
                    effect:"fadeIn",
                    effectTime:250,
                });
                return data.success;
            });

            jqxhr.done( function(results){
            //  results == data.success (array).
                $("span#page").text(page_index + 1);
                $("span#from").text(skip - snapshots.length + 1);
                $("span#to").text(skip + results.length);
                snapshots = snapshots.concat(results);
                $("span#length").text(snapshots.length);
            //  $("span#count").text(count);
            });

            jqxhr.fail( function( err ){
                console.error(err);
            });
        
            jqxhr.always( function(){
                countCatalogItems();
            });

        }, 500, selectors, options);
    });

</script>

</body>
</html>
